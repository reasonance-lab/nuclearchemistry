<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nuclear Reactions Lab - TEKS Chemistry</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
  }
}
</script>

<style>
:root {
  --bg-dark: #0a0e1a;
  --bg-panel: rgba(15, 23, 42, 0.95);
  --accent-blue: #3b82f6;
  --accent-cyan: #06b6d4;
  --accent-green: #10b981;
  --accent-yellow: #f59e0b;
  --accent-red: #ef4444;
  --accent-purple: #8b5cf6;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --border-color: rgba(148, 163, 184, 0.2);
  --glow-blue: rgba(59, 130, 246, 0.5);
  --glow-cyan: rgba(6, 182, 212, 0.5);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  background: var(--bg-dark);
  color: var(--text-primary);
  overflow: hidden;
}

#app {
  display: grid;
  grid-template-columns: 340px 1fr;
  grid-template-rows: 1fr;
  height: 100vh;
  gap: 0;
}

@media (max-width: 900px) {
  #app {
    grid-template-columns: 1fr;
    grid-template-rows: auto 1fr;
  }
  #sidebar { max-height: 45vh; overflow-y: auto; }
  #main3d { min-height: 55vh; }
}

/* Sidebar */
#sidebar {
  background: var(--bg-panel);
  border-right: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

.sidebar-header {
  padding: 20px;
  border-bottom: 1px solid var(--border-color);
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(6, 182, 212, 0.05));
}

.sidebar-header h1 {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: 4px;
  background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.sidebar-header .subtitle {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

/* Stats Bar */
.stats-bar {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border-color);
  background: rgba(0,0,0,0.2);
}

.stat-item {
  text-align: center;
  padding: 8px 4px;
  background: rgba(255,255,255,0.03);
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.stat-item .value {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--accent-cyan);
}

.stat-item .label {
  font-size: 0.65rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Progress Bar */
.progress-container {
  padding: 12px 20px;
  border-bottom: 1px solid var(--border-color);
}

.progress-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  margin-bottom: 6px;
  color: var(--text-secondary);
}

.progress-bar {
  height: 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
  border-radius: 4px;
  transition: width 0.5s ease;
  box-shadow: 0 0 10px var(--glow-cyan);
}

/* Level Navigation */
.level-nav {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-color);
}

.level-nav h3 {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.level-tabs {
  display: flex;
  gap: 6px;
}

.level-tab {
  flex: 1;
  padding: 10px 4px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background: rgba(255,255,255,0.02);
  color: var(--text-secondary);
  font-size: 0.7rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.level-tab:hover:not(.locked) {
  background: rgba(59, 130, 246, 0.1);
  border-color: var(--accent-blue);
}

.level-tab.active {
  background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
  border-color: transparent;
  color: white;
  box-shadow: 0 4px 15px var(--glow-blue);
}

.level-tab.locked {
  opacity: 0.4;
  cursor: not-allowed;
}

.level-tab.completed {
  border-color: var(--accent-green);
  color: var(--accent-green);
}

.level-tab .icon {
  font-size: 1rem;
  display: block;
  margin-bottom: 2px;
}

/* Content Area */
.content-area {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px;
}

.lesson-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}

.lesson-card h2 {
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.lesson-card p {
  font-size: 0.85rem;
  color: var(--text-secondary);
  line-height: 1.5;
  margin-bottom: 12px;
}

.lesson-card .highlight {
  background: rgba(59, 130, 246, 0.15);
  border-left: 3px solid var(--accent-blue);
  padding: 10px 12px;
  border-radius: 0 8px 8px 0;
  font-size: 0.8rem;
  margin: 12px 0;
}

.lesson-card .highlight strong {
  color: var(--accent-cyan);
}

/* Info Box */
.info-box {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(6, 182, 212, 0.05));
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 10px;
  padding: 12px;
  margin: 12px 0;
}

.info-box.warning {
  background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.05));
  border-color: rgba(245, 158, 11, 0.3);
}

.info-box h4 {
  font-size: 0.8rem;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.info-box p {
  font-size: 0.75rem;
  margin: 0;
}

/* Data Table */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75rem;
  margin: 12px 0;
}

.data-table th, .data-table td {
  padding: 8px 10px;
  border: 1px solid var(--border-color);
  text-align: left;
}

.data-table th {
  background: rgba(59, 130, 246, 0.1);
  font-weight: 600;
  color: var(--accent-cyan);
}

.data-table tr:nth-child(even) td {
  background: rgba(255,255,255,0.02);
}

/* Buttons */
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-family: inherit;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
  color: white;
  box-shadow: 0 4px 15px var(--glow-blue);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px var(--glow-blue);
}

.btn-secondary {
  background: rgba(255,255,255,0.1);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.btn-secondary:hover {
  background: rgba(255,255,255,0.15);
}

.btn-success {
  background: linear-gradient(135deg, var(--accent-green), #059669);
  color: white;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn-group {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 12px;
}

/* Quiz Section */
.quiz-section {
  background: rgba(139, 92, 246, 0.05);
  border: 1px solid rgba(139, 92, 246, 0.2);
  border-radius: 12px;
  padding: 16px;
  margin-top: 16px;
}

.quiz-section h3 {
  font-size: 0.9rem;
  color: var(--accent-purple);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.quiz-question {
  font-size: 0.85rem;
  margin-bottom: 12px;
  line-height: 1.5;
}

.quiz-options {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.quiz-option {
  padding: 10px 14px;
  background: rgba(255,255,255,0.05);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.2s;
}

.quiz-option:hover {
  background: rgba(139, 92, 246, 0.1);
  border-color: var(--accent-purple);
}

.quiz-option.selected {
  background: rgba(139, 92, 246, 0.2);
  border-color: var(--accent-purple);
}

.quiz-option.correct {
  background: rgba(16, 185, 129, 0.2);
  border-color: var(--accent-green);
}

.quiz-option.incorrect {
  background: rgba(239, 68, 68, 0.2);
  border-color: var(--accent-red);
}

.quiz-feedback {
  margin-top: 12px;
  padding: 10px;
  border-radius: 8px;
  font-size: 0.8rem;
  display: none;
}

.quiz-feedback.show { display: block; }
.quiz-feedback.correct {
  background: rgba(16, 185, 129, 0.15);
  border: 1px solid var(--accent-green);
  color: var(--accent-green);
}
.quiz-feedback.incorrect {
  background: rgba(239, 68, 68, 0.15);
  border: 1px solid var(--accent-red);
  color: var(--accent-red);
}

/* Input Fields */
.input-group {
  display: flex;
  gap: 8px;
  align-items: center;
  margin: 8px 0;
}

.input-field {
  padding: 8px 12px;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--text-primary);
  font-family: inherit;
  font-size: 0.85rem;
  width: 70px;
  text-align: center;
}

.input-field:focus {
  outline: none;
  border-color: var(--accent-cyan);
  box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
}

.input-label {
  font-size: 0.75rem;
  color: var(--text-secondary);
}

/* Equation Display */
.equation-display {
  background: rgba(0,0,0,0.3);
  padding: 16px;
  border-radius: 10px;
  font-size: 1.1rem;
  text-align: center;
  margin: 12px 0;
  border: 1px solid var(--border-color);
  font-family: 'Times New Roman', serif;
}

.equation-display .nuclide {
  display: inline-block;
  position: relative;
  padding-left: 20px;
  margin: 0 8px;
}

.equation-display .nuclide .mass {
  position: absolute;
  left: 0;
  top: -8px;
  font-size: 0.7em;
}

.equation-display .nuclide .atomic {
  position: absolute;
  left: 0;
  bottom: -8px;
  font-size: 0.7em;
}

.equation-display .nuclide .symbol {
  font-weight: bold;
}

.equation-display .arrow {
  margin: 0 12px;
  color: var(--accent-cyan);
}

.equation-display input {
  width: 45px;
  padding: 4px;
  text-align: center;
  background: rgba(59, 130, 246, 0.2);
  border: 2px dashed var(--accent-blue);
  border-radius: 4px;
  color: var(--text-primary);
  font-size: 0.9em;
  font-family: inherit;
}

/* 3D Canvas Area */
#main3d {
  position: relative;
  background: radial-gradient(ellipse at center, #0f172a 0%, #020617 100%);
  overflow: hidden;
}

#canvas-container {
  width: 100%;
  height: 100%;
}

#canvas-container canvas {
  display: block;
}

/* 3D Overlay Controls */
.canvas-overlay {
  position: absolute;
  pointer-events: none;
}

.canvas-overlay > * {
  pointer-events: auto;
}

#top-bar {
  top: 16px;
  left: 16px;
  right: 16px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

#bottom-bar {
  bottom: 16px;
  left: 16px;
  right: 16px;
  display: flex;
  justify-content: center;
}

/* Floating Panels */
.floating-panel {
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 12px 16px;
  backdrop-filter: blur(10px);
}

.nucleus-info {
  min-width: 180px;
}

.nucleus-info h4 {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  margin-bottom: 6px;
}

.nucleus-info .name {
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--accent-cyan);
  margin-bottom: 4px;
}

.nucleus-info .details {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

/* Action Buttons Panel */
.action-panel {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: center;
}

.action-btn {
  padding: 12px 20px;
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  color: var(--text-primary);
  font-family: inherit;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.action-btn:hover:not(:disabled) {
  background: rgba(59, 130, 246, 0.2);
  border-color: var(--accent-blue);
  transform: translateY(-2px);
}

.action-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.action-btn .icon {
  font-size: 1.2rem;
}

.action-btn.alpha { border-color: rgba(239, 68, 68, 0.5); }
.action-btn.alpha:hover:not(:disabled) { background: rgba(239, 68, 68, 0.2); }

.action-btn.beta { border-color: rgba(59, 130, 246, 0.5); }
.action-btn.beta:hover:not(:disabled) { background: rgba(59, 130, 246, 0.2); }

.action-btn.gamma { border-color: rgba(6, 182, 212, 0.5); }
.action-btn.gamma:hover:not(:disabled) { background: rgba(6, 182, 212, 0.2); }

.action-btn.fission { border-color: rgba(245, 158, 11, 0.5); }
.action-btn.fission:hover:not(:disabled) { background: rgba(245, 158, 11, 0.2); }

.action-btn.fusion { border-color: rgba(139, 92, 246, 0.5); }
.action-btn.fusion:hover:not(:disabled) { background: rgba(139, 92, 246, 0.2); }

/* Toast Notifications */
#toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.toast {
  padding: 12px 20px;
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  font-size: 0.85rem;
  animation: slideIn 0.3s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  max-width: 320px;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.toast.success { border-color: var(--accent-green); }
.toast.success::before { content: '‚úì'; color: var(--accent-green); font-weight: bold; }

.toast.error { border-color: var(--accent-red); }
.toast.error::before { content: '‚úó'; color: var(--accent-red); font-weight: bold; }

.toast.info { border-color: var(--accent-blue); }
.toast.info::before { content: '‚Ñπ'; color: var(--accent-blue); font-weight: bold; }

.toast.xp { border-color: var(--accent-yellow); }
.toast.xp::before { content: '‚≠ê'; }

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Particle Legend */
.particle-legend {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.particle-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.particle-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.particle-dot.proton { background: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); }
.particle-dot.neutron { background: #94a3b8; }
.particle-dot.electron { background: #3b82f6; box-shadow: 0 0 8px rgba(59, 130, 246, 0.6); }
.particle-dot.gamma { background: #06b6d4; box-shadow: 0 0 8px rgba(6, 182, 212, 0.6); }

/* Completion Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.modal-overlay.show {
  opacity: 1;
  visibility: visible;
}

.modal {
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 32px;
  max-width: 400px;
  text-align: center;
  transform: scale(0.9);
  transition: transform 0.3s;
}

.modal-overlay.show .modal {
  transform: scale(1);
}

.modal .icon {
  font-size: 4rem;
  margin-bottom: 16px;
}

.modal h2 {
  font-size: 1.5rem;
  margin-bottom: 8px;
  background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.modal p {
  color: var(--text-secondary);
  margin-bottom: 20px;
}

.modal .rewards {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-bottom: 20px;
}

.modal .reward {
  text-align: center;
}

.modal .reward .value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent-yellow);
}

.modal .reward .label {
  font-size: 0.7rem;
  color: var(--text-secondary);
}

/* Builder Mode */
.builder-controls {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin: 12px 0;
}

.builder-control {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--border-color);
  border-radius: 10px;
  padding: 12px;
}

.builder-control label {
  display: block;
  font-size: 0.7rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  margin-bottom: 6px;
}

.builder-control .value-display {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent-cyan);
  margin-bottom: 6px;
}

.builder-control input[type="range"] {
  width: 100%;
  cursor: pointer;
}

/* Sandbox selector */
.sandbox-select {
  width: 100%;
  padding: 10px;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  color: var(--text-primary);
  font-family: inherit;
  font-size: 0.85rem;
  cursor: pointer;
}

.sandbox-select option {
  background: var(--bg-dark);
}

/* Checkpoint Badge */
.checkpoint-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: linear-gradient(135deg, var(--accent-green), #059669);
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  color: white;
}

/* Sound Toggle */
#sound-toggle {
  position: absolute;
  top: 16px;
  right: 16px;
  padding: 8px 12px;
  background: var(--bg-panel);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 1.2rem;
  z-index: 100;
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.3);
}

/* Animations */
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

@keyframes glow {
  0%, 100% { box-shadow: 0 0 10px var(--glow-cyan); }
  50% { box-shadow: 0 0 20px var(--glow-cyan), 0 0 30px var(--glow-blue); }
}

.pulse { animation: pulse 2s infinite; }
.glow { animation: glow 2s infinite; }

/* Helper Classes */
.hidden { display: none !important; }
.text-center { text-align: center; }
.mt-2 { margin-top: 8px; }
.mt-3 { margin-top: 12px; }
.mb-2 { margin-bottom: 8px; }
.mb-3 { margin-bottom: 12px; }

/* Accessibility - Focus States */
button:focus-visible,
.btn:focus-visible,
.level-tab:focus-visible,
.quiz-option:focus-visible,
input:focus-visible,
select:focus-visible {
  outline: 2px solid var(--accent-cyan);
  outline-offset: 2px;
}

.action-btn:focus-visible {
  outline: 2px solid var(--accent-cyan);
  outline-offset: 2px;
  box-shadow: 0 0 0 4px var(--glow-cyan);
}

/* Skip focus ring for mouse users */
button:focus:not(:focus-visible),
.btn:focus:not(:focus-visible),
input:focus:not(:focus-visible) {
  outline: none;
}
</style>
</head>
<body>

<div id="app">
  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-header">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h1>Nuclear Reactions Lab</h1>
          <div class="subtitle">Texas TEKS Chemistry - Interactive Learning</div>
        </div>
        <button onclick="resetProgress()" title="Reset all progress" style="background:transparent; border:1px solid var(--border-color); border-radius:6px; padding:6px 10px; color:var(--text-secondary); cursor:pointer; font-size:0.7rem;">üîÑ Reset</button>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat-item">
        <div class="value" id="xp-display">0</div>
        <div class="label">XP Points</div>
      </div>
      <div class="stat-item">
        <div class="value" id="badge-display">0/5</div>
        <div class="label">Badges</div>
      </div>
      <div class="stat-item">
        <div class="value" id="safety-display">100%</div>
        <div class="label">Safety</div>
      </div>
    </div>

    <div class="progress-container">
      <div class="progress-label">
        <span>Overall Progress</span>
        <span id="progress-percent">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
    </div>

    <div class="level-nav">
      <h3>Learning Levels</h3>
      <div class="level-tabs">
        <button class="level-tab active" data-level="1">
          <span class="icon">üî¨</span>
          L1
        </button>
        <button class="level-tab locked" data-level="2">
          <span class="icon">‚ò¢Ô∏è</span>
          L2
        </button>
        <button class="level-tab locked" data-level="3">
          <span class="icon">‚öñÔ∏è</span>
          L3
        </button>
        <button class="level-tab locked" data-level="4">
          <span class="icon">‚ö°</span>
          L4
        </button>
        <button class="level-tab locked" data-level="5">
          <span class="icon">üèÜ</span>
          L5
        </button>
      </div>
    </div>

    <div class="content-area" id="content-area">
      <!-- Dynamic content loaded here -->
    </div>
  </div>

  <!-- 3D Canvas Area -->
  <div id="main3d">
    <div id="canvas-container"></div>

    <button id="sound-toggle" title="Toggle Sound">üîä</button>

    <div class="canvas-overlay" id="top-bar">
      <div class="floating-panel nucleus-info" id="nucleus-info">
        <h4>Current Nucleus</h4>
        <div class="name" id="nucleus-name">C-12</div>
        <div class="details" id="nucleus-details">Z=6 ¬∑ N=6 ¬∑ A=12</div>
        <div class="particle-legend">
          <span class="particle-item"><span class="particle-dot proton"></span>Proton</span>
          <span class="particle-item"><span class="particle-dot neutron"></span>Neutron</span>
        </div>
      </div>
    </div>

    <div class="canvas-overlay" id="bottom-bar">
      <div class="floating-panel action-panel" id="action-panel">
        <button class="action-btn alpha" id="btn-alpha" disabled>
          <span class="icon">üõ°Ô∏è</span> Alpha (Œ±)
        </button>
        <button class="action-btn beta" id="btn-beta" disabled>
          <span class="icon">‚ö°</span> Beta (Œ≤‚Åª)
        </button>
        <button class="action-btn gamma" id="btn-gamma" disabled>
          <span class="icon">‚ú®</span> Gamma (Œ≥)
        </button>
        <button class="action-btn fission" id="btn-fission" disabled>
          <span class="icon">üí•</span> Fission
        </button>
        <button class="action-btn fusion" id="btn-fusion" disabled>
          <span class="icon">üîó</span> Fusion
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Level Complete Modal -->
<div class="modal-overlay" id="level-modal">
  <div class="modal">
    <div class="icon">üéâ</div>
    <h2 id="modal-title">Level Complete!</h2>
    <p id="modal-message">You've mastered the basics of atomic structure.</p>
    <div class="rewards">
      <div class="reward">
        <div class="value" id="modal-xp">+100</div>
        <div class="label">XP Earned</div>
      </div>
      <div class="reward">
        <div class="value" id="modal-badge">üî¨</div>
        <div class="label">Badge</div>
      </div>
    </div>
    <button class="btn btn-primary" id="modal-continue">Continue to Next Level</button>
  </div>
</div>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";

// ============================================
// PERIODIC TABLE DATA
// ============================================
const ELEMENTS = [
  "", "H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca",
  "Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr",
  "Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe","Cs","Ba","La","Ce","Pr","Nd",
  "Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg",
  "Tl","Pb","Bi","Po","At","Rn","Fr","Ra","Ac","Th","Pa","U","Np","Pu"
];

const ELEMENT_NAMES = {
  1: "Hydrogen", 2: "Helium", 3: "Lithium", 4: "Beryllium", 5: "Boron",
  6: "Carbon", 7: "Nitrogen", 8: "Oxygen", 9: "Fluorine", 10: "Neon",
  11: "Sodium", 12: "Magnesium", 13: "Aluminum", 14: "Silicon", 15: "Phosphorus",
  16: "Sulfur", 17: "Chlorine", 18: "Argon", 19: "Potassium", 20: "Calcium",
  26: "Iron", 27: "Cobalt", 28: "Nickel", 29: "Copper", 30: "Zinc",
  36: "Krypton", 47: "Silver", 53: "Iodine", 55: "Cesium", 56: "Barium",
  79: "Gold", 80: "Mercury", 82: "Lead", 83: "Bismuth", 84: "Polonium",
  86: "Radon", 88: "Radium", 90: "Thorium", 92: "Uranium", 94: "Plutonium"
};

// ============================================
// GAME STATE
// ============================================
const state = {
  currentLevel: 1,
  unlockedLevels: [1],
  completedLevels: [],
  xp: 0,
  badges: [],
  safety: 100,

  // Nucleus state
  nucleus: { Z: 6, N: 6 },
  fusionPair: null,

  // Quiz state
  currentQuiz: null,
  quizScore: 0,
  quizTotal: 0,

  // Level progress
  levelProgress: {
    1: { tasksCompleted: 0, tasksTotal: 3 },
    2: { tasksCompleted: 0, tasksTotal: 3 },
    3: { tasksCompleted: 0, tasksTotal: 4 },
    4: { tasksCompleted: 0, tasksTotal: 3 },
    5: { tasksCompleted: 0, tasksTotal: 3 }
  },

  // Sound
  soundEnabled: true
};

// ============================================
// AUDIO SYSTEM
// ============================================
let audioCtx = null;

function ensureAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function playSound(type) {
  if (!state.soundEnabled) return;
  ensureAudio();

  const sounds = {
    click: { freq: 600, duration: 0.08, type: 'sine', gain: 0.1 },
    success: { freq: 880, duration: 0.15, type: 'sine', gain: 0.12 },
    error: { freq: 220, duration: 0.2, type: 'sawtooth', gain: 0.08 },
    levelUp: { freq: 523, duration: 0.3, type: 'sine', gain: 0.15 },
    decay: { freq: 300, duration: 0.25, type: 'triangle', gain: 0.1 },
    xp: { freq: 1000, duration: 0.1, type: 'sine', gain: 0.08 }
  };

  const s = sounds[type] || sounds.click;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.frequency.value = s.freq;
  osc.type = s.type;
  g.gain.value = s.gain;
  osc.connect(g).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + s.duration);

  if (type === 'levelUp') {
    setTimeout(() => {
      const osc2 = audioCtx.createOscillator();
      const g2 = audioCtx.createGain();
      osc2.frequency.value = 659;
      osc2.type = 'sine';
      g2.gain.value = 0.12;
      osc2.connect(g2).connect(audioCtx.destination);
      osc2.start();
      osc2.stop(audioCtx.currentTime + 0.15);
    }, 150);
    setTimeout(() => {
      const osc3 = audioCtx.createOscillator();
      const g3 = audioCtx.createGain();
      osc3.frequency.value = 784;
      osc3.type = 'sine';
      g3.gain.value = 0.12;
      osc3.connect(g3).connect(audioCtx.destination);
      osc3.start();
      osc3.stop(audioCtx.currentTime + 0.2);
    }, 300);
  }
}

// ============================================
// UI UTILITIES
// ============================================
function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span>${message}</span>`;
  container.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function addXP(amount) {
  state.xp = Math.max(0, state.xp + amount);
  document.getElementById('xp-display').textContent = state.xp;
  if (amount > 0) {
    showToast(`+${amount} XP`, 'xp');
    playSound('xp');
  } else if (amount < 0) {
    showToast(`${amount} XP`, 'info');
  }
  saveProgress();
}

function updateSafety(delta) {
  state.safety = Math.max(0, Math.min(100, state.safety + delta));
  document.getElementById('safety-display').textContent = state.safety + '%';

  // Visual warning for low safety
  const safetyEl = document.getElementById('safety-display');
  if (state.safety <= 30) {
    safetyEl.style.color = 'var(--accent-red)';
    if (delta < 0) showToast('‚ö†Ô∏è Safety low! Review carefully before answering.', 'error');
  } else if (state.safety <= 50) {
    safetyEl.style.color = 'var(--accent-yellow)';
  } else {
    safetyEl.style.color = 'var(--accent-cyan)';
  }
  saveProgress();
}

// ============================================
// PERSISTENCE (localStorage)
// ============================================
function saveProgress() {
  const data = {
    xp: state.xp,
    badges: state.badges,
    safety: state.safety,
    unlockedLevels: state.unlockedLevels,
    completedLevels: state.completedLevels,
    levelProgress: state.levelProgress
  };
  try {
    localStorage.setItem('nuclearLabProgress', JSON.stringify(data));
  } catch (e) {
    // localStorage not available
  }
}

function loadProgress() {
  try {
    const saved = localStorage.getItem('nuclearLabProgress');
    if (saved) {
      const data = JSON.parse(saved);
      state.xp = data.xp || 0;
      state.badges = data.badges || [];
      state.safety = data.safety || 100;
      state.unlockedLevels = data.unlockedLevels || [1];
      state.completedLevels = data.completedLevels || [];
      state.levelProgress = data.levelProgress || state.levelProgress;

      // Update UI
      document.getElementById('xp-display').textContent = state.xp;
      document.getElementById('safety-display').textContent = state.safety + '%';
      updateBadges();
      updateProgress();
      return true;
    }
  } catch (e) {
    // localStorage not available
  }
  return false;
}

function updateProgress() {
  const totalTasks = Object.values(state.levelProgress).reduce((a, b) => a + b.tasksTotal, 0);
  const completedTasks = Object.values(state.levelProgress).reduce((a, b) => a + b.tasksCompleted, 0);
  const percent = Math.round((completedTasks / totalTasks) * 100);
  document.getElementById('progress-percent').textContent = percent + '%';
  document.getElementById('progress-fill').style.width = percent + '%';
}

function updateBadges() {
  document.getElementById('badge-display').textContent = `${state.badges.length}/5`;
}

function nuclideLabel(Z, N) {
  const A = Z + N;
  const sym = ELEMENTS[Z] || `Z${Z}`;
  return `${sym}-${A}`;
}

function getElementName(Z) {
  return ELEMENT_NAMES[Z] || ELEMENTS[Z] || `Element ${Z}`;
}

function updateNucleusDisplay() {
  if (state.fusionPair) {
    const [a, b] = state.fusionPair;
    const labelA = nuclideLabel(a.Z, a.N);
    const labelB = nuclideLabel(b.Z, b.N);
    document.getElementById('nucleus-name').textContent = `${labelA} + ${labelB}`;
    document.getElementById('nucleus-details').textContent = `Fusion pair ready`;
  } else {
    const { Z, N } = state.nucleus;
    const A = Z + N;
    const name = nuclideLabel(Z, N);
    const elementName = getElementName(Z);
    document.getElementById('nucleus-name').textContent = name;
    document.getElementById('nucleus-details').textContent = `${elementName} ¬∑ Z=${Z} ¬∑ N=${N} ¬∑ A=${A}`;
  }
}

// ============================================
// THREE.JS SETUP
// ============================================
const container = document.getElementById('canvas-container');
const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x020617, 15, 50);

const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 200);
camera.position.set(0, 3, 10);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setPixelRatio(Math.min(2, window.devicePixelRatio));
renderer.setSize(container.clientWidth, container.clientHeight);
container.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.minDistance = 5;
controls.maxDistance = 20;

// Lighting
const ambientLight = new THREE.HemisphereLight(0x4488ff, 0x002244, 0.6);
scene.add(ambientLight);

const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
directionalLight.position.set(5, 10, 5);
scene.add(directionalLight);

const pointLight = new THREE.PointLight(0x06b6d4, 1.5, 20);
pointLight.position.set(0, 0, 0);
scene.add(pointLight);

// Grid
const gridHelper = new THREE.GridHelper(30, 30, 0x1e3a5f, 0x0f172a);
gridHelper.position.y = -4;
scene.add(gridHelper);

// Materials
const protonMaterial = new THREE.MeshStandardMaterial({
  color: 0xef4444,
  roughness: 0.3,
  metalness: 0.1,
  emissive: 0x330000,
  emissiveIntensity: 0.3
});

const neutronMaterial = new THREE.MeshStandardMaterial({
  color: 0x94a3b8,
  roughness: 0.4,
  metalness: 0.1
});

const electronMaterial = new THREE.MeshStandardMaterial({
  color: 0x3b82f6,
  roughness: 0.2,
  metalness: 0.2,
  emissive: 0x001133,
  emissiveIntensity: 0.5
});

const gammaMaterial = new THREE.MeshStandardMaterial({
  color: 0x06b6d4,
  roughness: 0.1,
  metalness: 0.3,
  emissive: 0x003344,
  emissiveIntensity: 0.8
});

const nucleonGeom = new THREE.SphereGeometry(0.3, 20, 20);
const particleGeom = new THREE.SphereGeometry(0.2, 16, 16);

// Groups
const nucleusGroup = new THREE.Group();
scene.add(nucleusGroup);

const particleGroup = new THREE.Group();
scene.add(particleGroup);

// ============================================
// NUCLEUS RENDERING
// ============================================
function packSphere(count, radius) {
  const positions = [];
  const maxTries = 5000;
  let tries = 0;

  while (positions.length < count && tries < maxTries) {
    tries++;
    const theta = Math.random() * Math.PI * 2;
    const phi = Math.acos(2 * Math.random() - 1);
    const r = Math.cbrt(Math.random()) * radius;

    const x = r * Math.sin(phi) * Math.cos(theta);
    const y = r * Math.sin(phi) * Math.sin(theta);
    const z = r * Math.cos(phi);

    const pos = new THREE.Vector3(x, y, z);

    let valid = true;
    for (const p of positions) {
      if (pos.distanceTo(p) < 0.55) {
        valid = false;
        break;
      }
    }

    if (valid) positions.push(pos);
  }

  while (positions.length < count) {
    positions.push(new THREE.Vector3(
      (Math.random() - 0.5) * radius * 2,
      (Math.random() - 0.5) * radius * 2,
      (Math.random() - 0.5) * radius * 2
    ));
  }

  return positions;
}

function buildNucleus(Z, N, offset = new THREE.Vector3(0, 0, 0)) {
  const A = Z + N;
  const radius = 0.5 + 0.08 * Math.pow(A, 0.4);
  const positions = packSphere(A, radius);

  const group = new THREE.Group();

  // Shuffle positions
  for (let i = positions.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [positions[i], positions[j]] = [positions[j], positions[i]];
  }

  // Add nucleons
  for (let i = 0; i < A; i++) {
    const isProton = i < Z;
    const mesh = new THREE.Mesh(nucleonGeom, isProton ? protonMaterial : neutronMaterial);
    mesh.position.copy(positions[i]);
    group.add(mesh);
  }

  // Add shell
  const shellGeom = new THREE.SphereGeometry(radius * 1.3, 24, 24);
  const shellMat = new THREE.MeshStandardMaterial({
    color: 0x3b82f6,
    transparent: true,
    opacity: 0.15,
    roughness: 0.8
  });
  const shell = new THREE.Mesh(shellGeom, shellMat);
  group.add(shell);

  // Add core glow
  const coreGeom = new THREE.SphereGeometry(radius * 0.4, 16, 16);
  const coreMat = new THREE.MeshBasicMaterial({
    color: 0x06b6d4,
    transparent: true,
    opacity: 0.4
  });
  const core = new THREE.Mesh(coreGeom, coreMat);
  group.add(core);

  group.position.copy(offset);
  return group;
}

function renderNucleus() {
  while (nucleusGroup.children.length) {
    nucleusGroup.remove(nucleusGroup.children[0]);
  }

  if (state.fusionPair) {
    const [a, b] = state.fusionPair;
    const groupA = buildNucleus(a.Z, a.N, new THREE.Vector3(-2.5, 0, 0));
    const groupB = buildNucleus(b.Z, b.N, new THREE.Vector3(2.5, 0, 0));
    nucleusGroup.add(groupA);
    nucleusGroup.add(groupB);
  } else {
    const group = buildNucleus(state.nucleus.Z, state.nucleus.N);
    nucleusGroup.add(group);
  }

  updateNucleusDisplay();
}

// ============================================
// DECAY ANIMATIONS
// ============================================
let animationState = { active: false, type: null, progress: 0, particles: [] };

function startDecayAnimation(type) {
  animationState = { active: true, type, progress: 0, particles: [] };
  playSound('decay');

  // Clear existing particles
  while (particleGroup.children.length) {
    particleGroup.remove(particleGroup.children[0]);
  }

  if (type === 'alpha') {
    // Emit 2 protons and 2 neutrons as alpha particle
    for (let i = 0; i < 2; i++) {
      const proton = new THREE.Mesh(particleGeom, protonMaterial.clone());
      const neutron = new THREE.Mesh(particleGeom, neutronMaterial.clone());
      proton.position.set(0.1 * i, 0.1 * i, 0);
      neutron.position.set(-0.1 * i, 0.1 * (i + 1), 0);
      particleGroup.add(proton);
      particleGroup.add(neutron);
      animationState.particles.push(
        { mesh: proton, velocity: new THREE.Vector3(0.15 + Math.random() * 0.05, 0.05, 0.02) },
        { mesh: neutron, velocity: new THREE.Vector3(0.14 + Math.random() * 0.05, 0.03, -0.02) }
      );
    }
  } else if (type === 'beta') {
    const electron = new THREE.Mesh(particleGeom, electronMaterial.clone());
    electron.scale.setScalar(0.6);
    particleGroup.add(electron);
    animationState.particles.push({
      mesh: electron,
      velocity: new THREE.Vector3(0.25, 0.08, 0.05)
    });
  } else if (type === 'gamma') {
    const gamma = new THREE.Mesh(particleGeom, gammaMaterial.clone());
    gamma.scale.setScalar(0.5);
    particleGroup.add(gamma);
    animationState.particles.push({
      mesh: gamma,
      velocity: new THREE.Vector3(0.3, 0, 0)
    });
  }
}

function updateAnimation(delta) {
  if (!animationState.active) return;

  animationState.progress += delta;

  for (const p of animationState.particles) {
    p.mesh.position.add(p.velocity);
    p.mesh.material.opacity = Math.max(0, 1 - animationState.progress / 2);
    p.mesh.material.transparent = true;
  }

  if (animationState.progress > 2.5) {
    animationState.active = false;
    while (particleGroup.children.length) {
      particleGroup.remove(particleGroup.children[0]);
    }
  }
}

// ============================================
// DECAY FUNCTIONS
// ============================================
function performAlphaDecay() {
  if (state.nucleus.Z < 2 || state.nucleus.N < 2) {
    showToast('Need at least 2 protons and 2 neutrons for alpha decay', 'error');
    return false;
  }

  state.nucleus.Z -= 2;
  state.nucleus.N -= 2;
  startDecayAnimation('alpha');
  renderNucleus();
  return true;
}

function performBetaDecay() {
  if (state.nucleus.N < 1) {
    showToast('Need at least 1 neutron for beta decay', 'error');
    return false;
  }

  state.nucleus.Z += 1;
  state.nucleus.N -= 1;
  startDecayAnimation('beta');
  renderNucleus();
  return true;
}

function performGammaEmission() {
  startDecayAnimation('gamma');
  // Gamma doesn't change Z or N
  return true;
}

function performFission() {
  if (state.nucleus.Z !== 92) {
    showToast('Fission demo requires Uranium-235', 'error');
    return false;
  }

  showToast('Fission: U-235 ‚Üí Ba-141 + Kr-92 + 3n', 'info');
  state.nucleus = { Z: 56, N: 85 }; // Barium-141
  renderNucleus();
  return true;
}

function performFusion() {
  if (!state.fusionPair) {
    showToast('Load fusion pair (D + T) first', 'error');
    return false;
  }

  showToast('Fusion: D + T ‚Üí He-4 + n + 17.6 MeV', 'info');
  state.fusionPair = null;
  state.nucleus = { Z: 2, N: 2 }; // Helium-4
  renderNucleus();
  return true;
}

// ============================================
// LEVEL CONTENT
// ============================================
const levelContent = {
  1: {
    title: "Level 1: Atomic Foundations",
    badge: "üî¨",
    badgeName: "Atom Builder",
    content: `
      <div class="lesson-card">
        <h2>üî¨ Welcome to Nuclear Chemistry!</h2>
        <p>Before we explore nuclear reactions, let's make sure you understand the basics of atomic structure. Every atom has a <strong>nucleus</strong> at its center.</p>

        <div class="highlight">
          <strong>The nucleus contains:</strong><br>
          ‚Ä¢ <strong>Protons (p‚Å∫)</strong> - positive charge, determines the element<br>
          ‚Ä¢ <strong>Neutrons (n‚Å∞)</strong> - no charge, affects stability
        </div>

        <div class="info-box">
          <h4>üìù Key Terms</h4>
          <p><strong>Atomic Number (Z)</strong> = number of protons<br>
          <strong>Mass Number (A)</strong> = protons + neutrons (Z + N)<br>
          <strong>Neutron Number (N)</strong> = A - Z</p>
        </div>
      </div>

      <div class="lesson-card">
        <h2>üìä Isotope Notation</h2>
        <p>Scientists write isotopes using a special notation:</p>

        <div class="equation-display">
          <span class="nuclide">
            <span class="mass">A</span>
            <span class="atomic">Z</span>
            <span class="symbol">X</span>
          </span>
          &nbsp; or &nbsp; X-A
        </div>

        <p>For example, Carbon-12 has 6 protons and 6 neutrons:</p>

        <div class="equation-display">
          <span class="nuclide">
            <span class="mass">12</span>
            <span class="atomic">6</span>
            <span class="symbol">C</span>
          </span>
          &nbsp; = &nbsp; C-12
        </div>

        <table class="data-table">
          <tr><th>Isotope</th><th>Z (protons)</th><th>N (neutrons)</th><th>A (mass)</th></tr>
          <tr><td>C-12</td><td>6</td><td>6</td><td>12</td></tr>
          <tr><td>C-14</td><td>6</td><td>8</td><td>14</td></tr>
          <tr><td>U-235</td><td>92</td><td>143</td><td>235</td></tr>
        </table>
      </div>

      <div class="lesson-card">
        <h2>üéÆ Try It: Build a Nucleus</h2>
        <p>Use the controls below to build different isotopes. Watch the 3D model update!</p>

        <div class="builder-controls">
          <div class="builder-control">
            <label>Protons (Z)</label>
            <div class="value-display" id="proton-value">6</div>
            <input type="range" id="proton-slider" min="1" max="92" value="6">
          </div>
          <div class="builder-control">
            <label>Neutrons (N)</label>
            <div class="value-display" id="neutron-value">6</div>
            <input type="range" id="neutron-slider" min="0" max="146" value="6">
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="loadPreset('C-12')">Load C-12</button>
          <button class="btn btn-secondary" onclick="loadPreset('C-14')">Load C-14</button>
          <button class="btn btn-secondary" onclick="loadPreset('U-235')">Load U-235</button>
        </div>
      </div>

      <div class="quiz-section" id="quiz-l1">
        <h3>üìù Checkpoint Quiz</h3>
        <div class="quiz-question">Carbon-14 has 6 protons. How many neutrons does it have?</div>
        <div class="quiz-options">
          <div class="quiz-option" data-answer="6">6 neutrons</div>
          <div class="quiz-option" data-answer="8" data-correct="true">8 neutrons</div>
          <div class="quiz-option" data-answer="14">14 neutrons</div>
          <div class="quiz-option" data-answer="20">20 neutrons</div>
        </div>
        <div class="quiz-feedback" id="feedback-l1"></div>
        <div class="btn-group">
          <button class="btn btn-primary" id="check-l1" onclick="checkQuiz(1)">Check Answer</button>
        </div>
      </div>
    `
  },

  2: {
    title: "Level 2: Types of Radiation",
    badge: "‚ò¢Ô∏è",
    badgeName: "Radiation Expert",
    content: `
      <div class="lesson-card">
        <h2>‚ò¢Ô∏è Radioactive Decay</h2>
        <p>Unstable nuclei release energy by emitting radiation. There are three main types:</p>

        <table class="data-table">
          <tr>
            <th>Type</th>
            <th>Symbol</th>
            <th>What is it?</th>
            <th>Charge</th>
          </tr>
          <tr>
            <td><span style="color:#ef4444">Alpha (Œ±)</span></td>
            <td>‚Å¥‚ÇÇHe</td>
            <td>2 protons + 2 neutrons</td>
            <td>+2</td>
          </tr>
          <tr>
            <td><span style="color:#3b82f6">Beta (Œ≤‚Åª)</span></td>
            <td>‚Å∞‚Çã‚ÇÅe</td>
            <td>High-speed electron</td>
            <td>-1</td>
          </tr>
          <tr>
            <td><span style="color:#06b6d4">Gamma (Œ≥)</span></td>
            <td>Œ≥</td>
            <td>Electromagnetic wave</td>
            <td>0</td>
          </tr>
        </table>
      </div>

      <div class="lesson-card">
        <h2>üõ°Ô∏è Penetrating Power</h2>
        <p>Different radiation types can pass through different materials:</p>

        <div class="highlight">
          <strong>Alpha (Œ±)</strong>: Stopped by paper or skin<br>
          <strong>Beta (Œ≤‚Åª)</strong>: Stopped by aluminum or thick plastic<br>
          <strong>Gamma (Œ≥)</strong>: Needs thick lead or concrete
        </div>

        <div class="info-box">
          <h4>üí° Remember</h4>
          <p>Penetrating power: Œ≥ > Œ≤ > Œ±<br>
          Ionizing ability: Œ± > Œ≤ > Œ≥</p>
        </div>
      </div>

      <div class="lesson-card">
        <h2>üéÆ Try It: Watch Decay Happen</h2>
        <p>Load an isotope and trigger a decay reaction to see the particles emitted!</p>

        <select class="sandbox-select" id="isotope-select-l2" onchange="loadIsotopeL2()">
          <option value="84,126">Polonium-210 (Œ± decay)</option>
          <option value="6,8">Carbon-14 (Œ≤‚Åª decay)</option>
          <option value="27,33">Cobalt-60 (Œ≥ emission)</option>
        </select>

        <div class="btn-group">
          <button class="btn btn-secondary alpha" onclick="tryDecay('alpha')">üõ°Ô∏è Alpha</button>
          <button class="btn btn-secondary beta" onclick="tryDecay('beta')">‚ö° Beta</button>
          <button class="btn btn-secondary gamma" onclick="tryDecay('gamma')">‚ú® Gamma</button>
        </div>
      </div>

      <div class="quiz-section" id="quiz-l2">
        <h3>üìù Checkpoint Quiz</h3>
        <div class="quiz-question">Which type of radiation is stopped by a sheet of paper?</div>
        <div class="quiz-options">
          <div class="quiz-option" data-answer="alpha" data-correct="true">Alpha (Œ±)</div>
          <div class="quiz-option" data-answer="beta">Beta (Œ≤‚Åª)</div>
          <div class="quiz-option" data-answer="gamma">Gamma (Œ≥)</div>
          <div class="quiz-option" data-answer="all">All of them</div>
        </div>
        <div class="quiz-feedback" id="feedback-l2"></div>
        <div class="btn-group">
          <button class="btn btn-primary" id="check-l2" onclick="checkQuiz(2)">Check Answer</button>
        </div>
      </div>
    `
  },

  3: {
    title: "Level 3: Balancing Nuclear Equations",
    badge: "‚öñÔ∏è",
    badgeName: "Equation Master",
    content: `
      <div class="lesson-card">
        <h2>‚öñÔ∏è Conservation Laws</h2>
        <p>In nuclear equations, two things must always be conserved (stay balanced):</p>

        <div class="highlight">
          <strong>1. Mass Number (A)</strong>: Total A on left = Total A on right<br>
          <strong>2. Atomic Number (Z)</strong>: Total Z on left = Total Z on right
        </div>
      </div>

      <div class="lesson-card">
        <h2>üìñ Decay Equation Rules</h2>

        <table class="data-table">
          <tr><th>Decay</th><th>What happens</th><th>A change</th><th>Z change</th></tr>
          <tr><td>Alpha (Œ±)</td><td>Loses ‚Å¥‚ÇÇHe</td><td>‚àí4</td><td>‚àí2</td></tr>
          <tr><td>Beta (Œ≤‚Åª)</td><td>n ‚Üí p + e‚Åª</td><td>0</td><td>+1</td></tr>
          <tr><td>Gamma (Œ≥)</td><td>Energy only</td><td>0</td><td>0</td></tr>
        </table>
      </div>

      <div class="lesson-card">
        <h2>‚úèÔ∏è Example: Alpha Decay</h2>
        <p>Polonium-210 undergoes alpha decay:</p>

        <div class="equation-display">
          <span class="nuclide"><span class="mass">210</span><span class="atomic">84</span><span class="symbol">Po</span></span>
          <span class="arrow">‚Üí</span>
          <span class="nuclide"><span class="mass">206</span><span class="atomic">82</span><span class="symbol">Pb</span></span>
          +
          <span class="nuclide"><span class="mass">4</span><span class="atomic">2</span><span class="symbol">He</span></span>
        </div>

        <div class="info-box">
          <h4>‚úì Check the balance:</h4>
          <p>A: 210 = 206 + 4 ‚úì<br>
          Z: 84 = 82 + 2 ‚úì</p>
        </div>
      </div>

      <div class="lesson-card">
        <h2>üéÆ Practice: Balance This Equation</h2>
        <p>Carbon-14 undergoes beta decay. Fill in the missing numbers:</p>

        <div class="equation-display" id="equation-practice">
          <span class="nuclide"><span class="mass">14</span><span class="atomic">6</span><span class="symbol">C</span></span>
          <span class="arrow">‚Üí</span>
          <span class="nuclide">
            <span class="mass"><input type="text" id="ans-A" maxlength="3" style="width:35px"></span>
            <span class="atomic"><input type="text" id="ans-Z" maxlength="2" style="width:35px"></span>
            <span class="symbol">N</span>
          </span>
          +
          <span class="nuclide"><span class="mass">0</span><span class="atomic">-1</span><span class="symbol">e</span></span>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="checkEquation()">Check Equation</button>
          <button class="btn btn-secondary" onclick="showHint3()">üí° Hint</button>
        </div>
        <div class="quiz-feedback" id="feedback-l3"></div>
      </div>

      <div class="quiz-section" id="quiz-l3">
        <h3>üìù Final Quiz</h3>
        <div class="quiz-question">In gamma emission, what happens to A and Z?</div>
        <div class="quiz-options">
          <div class="quiz-option" data-answer="both-decrease">Both decrease</div>
          <div class="quiz-option" data-answer="a-stays-z-increases">A stays same, Z increases</div>
          <div class="quiz-option" data-answer="both-stay" data-correct="true">Both stay the same</div>
          <div class="quiz-option" data-answer="a-decreases">A decreases by 4</div>
        </div>
        <div class="quiz-feedback" id="feedback-l3-quiz"></div>
        <div class="btn-group">
          <button class="btn btn-primary" id="check-l3" onclick="checkQuiz(3)">Check Answer</button>
        </div>
      </div>
    `
  },

  4: {
    title: "Level 4: Fission & Fusion",
    badge: "‚ö°",
    badgeName: "Nuclear Engineer",
    content: `
      <div class="lesson-card">
        <h2>üí• Nuclear Fission</h2>
        <p><strong>Fission</strong> = splitting a heavy nucleus into smaller pieces</p>

        <div class="highlight">
          <strong>Example:</strong> Uranium-235 + neutron ‚Üí Barium + Krypton + 3 neutrons + energy
        </div>

        <div class="equation-display" style="font-size: 0.9rem;">
          <span class="nuclide"><span class="mass">235</span><span class="atomic">92</span><span class="symbol">U</span></span>
          +
          <span class="nuclide"><span class="mass">1</span><span class="atomic">0</span><span class="symbol">n</span></span>
          <span class="arrow">‚Üí</span>
          <span class="nuclide"><span class="mass">141</span><span class="atomic">56</span><span class="symbol">Ba</span></span>
          +
          <span class="nuclide"><span class="mass">92</span><span class="atomic">36</span><span class="symbol">Kr</span></span>
          + 3
          <span class="nuclide"><span class="mass">1</span><span class="atomic">0</span><span class="symbol">n</span></span>
        </div>

        <div class="info-box">
          <h4>‚ö° Energy Released</h4>
          <p>~200 MeV per fission event<br>
          Used in: Nuclear power plants</p>
        </div>
      </div>

      <div class="lesson-card">
        <h2>üîó Nuclear Fusion</h2>
        <p><strong>Fusion</strong> = combining light nuclei into a heavier one</p>

        <div class="highlight">
          <strong>Example:</strong> Deuterium + Tritium ‚Üí Helium-4 + neutron + energy
        </div>

        <div class="equation-display">
          <span class="nuclide"><span class="mass">2</span><span class="atomic">1</span><span class="symbol">H</span></span>
          +
          <span class="nuclide"><span class="mass">3</span><span class="atomic">1</span><span class="symbol">H</span></span>
          <span class="arrow">‚Üí</span>
          <span class="nuclide"><span class="mass">4</span><span class="atomic">2</span><span class="symbol">He</span></span>
          +
          <span class="nuclide"><span class="mass">1</span><span class="atomic">0</span><span class="symbol">n</span></span>
        </div>

        <div class="info-box">
          <h4>‚òÄÔ∏è Where It Happens</h4>
          <p>In the Sun and stars!<br>
          Requires extreme temperature (~15 million ¬∞C)</p>
        </div>
      </div>

      <div class="lesson-card">
        <h2>üìä Comparison</h2>
        <table class="data-table">
          <tr><th>Aspect</th><th>Fission</th><th>Fusion</th></tr>
          <tr><td>Process</td><td>Splitting heavy nuclei</td><td>Combining light nuclei</td></tr>
          <tr><td>Fuel</td><td>U-235, Pu-239</td><td>H-2, H-3</td></tr>
          <tr><td>Energy/nucleon</td><td>Lower</td><td>Higher</td></tr>
          <tr><td>Current use</td><td>Power plants</td><td>Experimental</td></tr>
          <tr><td>In nature</td><td>Rare</td><td>Stars</td></tr>
        </table>
      </div>

      <div class="lesson-card">
        <h2>üéÆ Try It: Trigger Reactions</h2>

        <select class="sandbox-select" id="isotope-select-l4" onchange="loadIsotopeL4()">
          <option value="fission">Uranium-235 (Fission)</option>
          <option value="fusion">Deuterium + Tritium (Fusion)</option>
        </select>

        <div class="btn-group">
          <button class="btn btn-secondary fission" onclick="triggerFission()">üí• Trigger Fission</button>
          <button class="btn btn-secondary fusion" onclick="triggerFusion()">üîó Trigger Fusion</button>
        </div>
      </div>

      <div class="quiz-section" id="quiz-l4">
        <h3>üìù Checkpoint Quiz</h3>
        <div class="quiz-question">Which process powers the Sun?</div>
        <div class="quiz-options">
          <div class="quiz-option" data-answer="fission">Nuclear fission</div>
          <div class="quiz-option" data-answer="fusion" data-correct="true">Nuclear fusion</div>
          <div class="quiz-option" data-answer="both">Both equally</div>
          <div class="quiz-option" data-answer="neither">Neither</div>
        </div>
        <div class="quiz-feedback" id="feedback-l4"></div>
        <div class="btn-group">
          <button class="btn btn-primary" id="check-l4" onclick="checkQuiz(4)">Check Answer</button>
        </div>
      </div>
    `
  },

  5: {
    title: "Level 5: Real-World Applications",
    badge: "üèÜ",
    badgeName: "Nuclear Scientist",
    content: `
      <div class="lesson-card">
        <h2>üèÜ Nuclear Technology in Our Lives</h2>
        <p>Nuclear science isn't just about power plants! It helps us in many ways:</p>
      </div>

      <div class="lesson-card">
        <h2>üè• Medical Applications</h2>
        <table class="data-table">
          <tr><th>Application</th><th>Radiation</th><th>How it works</th></tr>
          <tr><td>PET Scans</td><td>Œ≤‚Å∫ (positron)</td><td>Detects cancer, brain activity</td></tr>
          <tr><td>Cancer therapy</td><td>Œ≥ rays</td><td>Kills cancer cells</td></tr>
          <tr><td>Bone scans</td><td>Œ≥ (Tc-99m)</td><td>Shows bone problems</td></tr>
        </table>

        <div class="info-box">
          <h4>üí° Why Gamma?</h4>
          <p>Gamma rays can penetrate deep into the body, making them useful for imaging and treating internal problems.</p>
        </div>
      </div>

      <div class="lesson-card">
        <h2>‚ö° Energy Production</h2>

        <div class="highlight">
          <strong>Nuclear Power Plants</strong><br>
          ‚Ä¢ Use controlled fission of U-235<br>
          ‚Ä¢ Generate ~20% of US electricity<br>
          ‚Ä¢ No greenhouse gas emissions during operation<br>
          ‚Ä¢ Challenge: radioactive waste storage
        </div>

        <div class="info-box">
          <h4>üîÆ Future: Fusion Power</h4>
          <p>Scientists are working on fusion reactors (like ITER). If successful, fusion could provide nearly unlimited clean energy!</p>
        </div>
      </div>

      <div class="lesson-card">
        <h2>üè† Everyday Uses</h2>
        <table class="data-table">
          <tr><th>Application</th><th>Radiation</th><th>Purpose</th></tr>
          <tr><td>Smoke detectors</td><td>Œ± (Am-241)</td><td>Ionizes air to detect smoke</td></tr>
          <tr><td>Food irradiation</td><td>Œ≥ rays</td><td>Kills bacteria, extends shelf life</td></tr>
          <tr><td>Carbon dating</td><td>Œ≤ (C-14)</td><td>Determines age of artifacts</td></tr>
        </table>
      </div>

      <div class="lesson-card">
        <h2>üéÆ Application Challenge</h2>
        <p>Match the radiation type to its best application:</p>

        <div class="input-group">
          <span class="input-label">Smoke detector uses:</span>
          <select class="sandbox-select" id="app-q1" style="width:120px">
            <option value="">Select...</option>
            <option value="alpha">Alpha</option>
            <option value="beta">Beta</option>
            <option value="gamma">Gamma</option>
          </select>
        </div>

        <div class="input-group">
          <span class="input-label">Medical imaging uses:</span>
          <select class="sandbox-select" id="app-q2" style="width:120px">
            <option value="">Select...</option>
            <option value="alpha">Alpha</option>
            <option value="beta">Beta</option>
            <option value="gamma">Gamma</option>
          </select>
        </div>

        <div class="input-group">
          <span class="input-label">Power plants use:</span>
          <select class="sandbox-select" id="app-q3" style="width:120px">
            <option value="">Select...</option>
            <option value="fission">Fission</option>
            <option value="fusion">Fusion</option>
          </select>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="checkApplications()">Check Answers</button>
        </div>
        <div class="quiz-feedback" id="feedback-l5-app"></div>
      </div>

      <div class="quiz-section" id="quiz-l5">
        <h3>üìù Final Assessment</h3>
        <div class="quiz-question">Why is alpha radiation used in smoke detectors even though it's highly ionizing?</div>
        <div class="quiz-options">
          <div class="quiz-option" data-answer="cheap">It's the cheapest option</div>
          <div class="quiz-option" data-answer="shielded" data-correct="true">It's easily shielded and contained safely</div>
          <div class="quiz-option" data-answer="colorful">It produces visible light</div>
          <div class="quiz-option" data-answer="loud">It makes a sound when triggered</div>
        </div>
        <div class="quiz-feedback" id="feedback-l5"></div>
        <div class="btn-group">
          <button class="btn btn-primary" id="check-l5" onclick="checkQuiz(5)">Check Answer</button>
        </div>
      </div>

      <div class="lesson-card text-center">
        <h2>üéì Congratulations!</h2>
        <p>You've completed the Nuclear Reactions curriculum aligned with Texas TEKS standards!</p>
        <div class="checkpoint-badge" style="display:inline-flex; margin-top:12px;">
          ‚úì TEKS ¬ß112.35(c)(14) Complete
        </div>
      </div>
    `
  }
};

// ============================================
// LEVEL MANAGEMENT
// ============================================
function loadLevel(level) {
  if (!state.unlockedLevels.includes(level)) {
    showToast('Complete the previous level first!', 'error');
    playSound('error');
    return;
  }

  state.currentLevel = level;
  playSound('click');

  // Update tabs
  document.querySelectorAll('.level-tab').forEach((tab, idx) => {
    const tabLevel = idx + 1;
    tab.classList.remove('active');
    tab.classList.toggle('locked', !state.unlockedLevels.includes(tabLevel));
    tab.classList.toggle('completed', state.completedLevels.includes(tabLevel));
    if (tabLevel === level) tab.classList.add('active');
  });

  // Load content
  const content = levelContent[level];
  document.getElementById('content-area').innerHTML = content.content;

  // Setup level-specific handlers
  setupLevelHandlers(level);

  // Update action buttons
  updateActionButtons(level);

  // Load appropriate nucleus
  if (level === 1) {
    state.nucleus = { Z: 6, N: 6 };
    state.fusionPair = null;
  } else if (level === 2) {
    state.nucleus = { Z: 84, N: 126 };
    state.fusionPair = null;
  } else if (level === 3) {
    state.nucleus = { Z: 6, N: 8 };
    state.fusionPair = null;
  } else if (level === 4) {
    state.nucleus = { Z: 92, N: 143 };
    state.fusionPair = null;
  } else if (level === 5) {
    state.nucleus = { Z: 6, N: 6 };
    state.fusionPair = null;
  }

  renderNucleus();
}

function setupLevelHandlers(level) {
  if (level === 1) {
    const protonSlider = document.getElementById('proton-slider');
    const neutronSlider = document.getElementById('neutron-slider');

    if (protonSlider) {
      protonSlider.addEventListener('input', () => {
        const Z = parseInt(protonSlider.value);
        document.getElementById('proton-value').textContent = Z;
        state.nucleus.Z = Z;
        state.fusionPair = null;
        renderNucleus();
      });
    }

    if (neutronSlider) {
      neutronSlider.addEventListener('input', () => {
        const N = parseInt(neutronSlider.value);
        document.getElementById('neutron-value').textContent = N;
        state.nucleus.N = N;
        state.fusionPair = null;
        renderNucleus();
      });
    }
  }

  // Setup equation input Enter key handlers (Level 3)
  if (level === 3) {
    const ansA = document.getElementById('ans-A');
    const ansZ = document.getElementById('ans-Z');
    if (ansA) {
      ansA.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') window.checkEquation();
      });
    }
    if (ansZ) {
      ansZ.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') window.checkEquation();
      });
    }
  }

  // Setup quiz option handlers
  document.querySelectorAll('.quiz-option').forEach(opt => {
    opt.addEventListener('click', () => {
      opt.parentElement.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
      playSound('click');
    });
  });
}

function updateActionButtons(level) {
  const btnAlpha = document.getElementById('btn-alpha');
  const btnBeta = document.getElementById('btn-beta');
  const btnGamma = document.getElementById('btn-gamma');
  const btnFission = document.getElementById('btn-fission');
  const btnFusion = document.getElementById('btn-fusion');

  // Disable all by default
  [btnAlpha, btnBeta, btnGamma, btnFission, btnFusion].forEach(btn => btn.disabled = true);

  // Enable based on level
  if (level >= 2) {
    btnAlpha.disabled = false;
    btnBeta.disabled = false;
    btnGamma.disabled = false;
  }
  if (level >= 4) {
    btnFission.disabled = false;
    btnFusion.disabled = false;
  }
}

function completeLevel(level) {
  if (state.completedLevels.includes(level)) return;

  state.completedLevels.push(level);
  const content = levelContent[level];

  // Award XP and badge
  addXP(100);
  state.badges.push(content.badge);
  updateBadges();
  playSound('levelUp');

  // Unlock next level
  const nextLevel = level + 1;
  if (nextLevel <= 5 && !state.unlockedLevels.includes(nextLevel)) {
    state.unlockedLevels.push(nextLevel);
  }

  // Update progress
  state.levelProgress[level].tasksCompleted = state.levelProgress[level].tasksTotal;
  updateProgress();

  // Show modal
  document.getElementById('modal-title').textContent = `${content.title} Complete!`;
  document.getElementById('modal-message').textContent = `You've earned the "${content.badgeName}" badge!`;
  document.getElementById('modal-xp').textContent = '+100';
  document.getElementById('modal-badge').textContent = content.badge;
  document.getElementById('level-modal').classList.add('show');

  // Update continue button
  const continueBtn = document.getElementById('modal-continue');
  if (nextLevel <= 5) {
    continueBtn.textContent = 'Continue to Level ' + nextLevel;
    continueBtn.onclick = () => {
      document.getElementById('level-modal').classList.remove('show');
      loadLevel(nextLevel);
    };
  } else {
    continueBtn.textContent = 'View Certificate';
    continueBtn.onclick = () => {
      document.getElementById('level-modal').classList.remove('show');
      showToast('Congratulations! You completed all levels!', 'success');
    };
  }

  // Update tab
  document.querySelector(`.level-tab[data-level="${level}"]`).classList.add('completed');

  // Save progress
  saveProgress();
}

// ============================================
// QUIZ & INTERACTION HANDLERS
// ============================================
window.checkQuiz = function(level) {
  const container = document.getElementById(`quiz-l${level}`) || document.querySelector('.quiz-section');
  const selected = container.querySelector('.quiz-option.selected');
  const feedbackId = level === 3 ? 'feedback-l3-quiz' : `feedback-l${level}`;
  const feedback = document.getElementById(feedbackId);
  const checkBtn = document.getElementById(`check-l${level}`);

  if (!selected) {
    showToast('Please select an answer first', 'error');
    return;
  }

  const isCorrect = selected.hasAttribute('data-correct');

  // Show visual feedback on options
  container.querySelectorAll('.quiz-option').forEach(opt => {
    if (opt.hasAttribute('data-correct')) {
      opt.classList.add('correct');
    } else if (opt === selected && !isCorrect) {
      opt.classList.add('incorrect');
    }
  });

  // Show feedback message
  feedback.classList.add('show');
  if (isCorrect) {
    feedback.className = 'quiz-feedback show correct';
    feedback.textContent = '‚úì Correct! Great job!';
    addXP(25);
    playSound('success');
    checkBtn.disabled = true;

    // Mark level complete after short delay
    setTimeout(() => completeLevel(level), 1500);
  } else {
    feedback.className = 'quiz-feedback show incorrect';
    feedback.textContent = '‚úó Not quite. Try again! Hint: Look at the lesson content above.';
    updateSafety(-5);
    playSound('error');

    // Allow retry - reset selection after delay
    setTimeout(() => {
      container.querySelectorAll('.quiz-option').forEach(opt => {
        opt.classList.remove('selected', 'incorrect', 'correct');
      });
      feedback.classList.remove('show');
    }, 2500);
  }
};

window.loadPreset = function(name) {
  playSound('click');
  const presets = {
    'C-12': { Z: 6, N: 6 },
    'C-14': { Z: 6, N: 8 },
    'U-235': { Z: 92, N: 143 }
  };

  const preset = presets[name];
  if (preset) {
    state.nucleus = { ...preset };
    state.fusionPair = null;

    // Update sliders if they exist
    const protonSlider = document.getElementById('proton-slider');
    const neutronSlider = document.getElementById('neutron-slider');
    if (protonSlider) {
      protonSlider.value = preset.Z;
      document.getElementById('proton-value').textContent = preset.Z;
    }
    if (neutronSlider) {
      neutronSlider.value = preset.N;
      document.getElementById('neutron-value').textContent = preset.N;
    }

    renderNucleus();
    showToast(`Loaded ${name}`, 'info');
  }
};

window.loadIsotopeL2 = function() {
  const select = document.getElementById('isotope-select-l2');
  const [Z, N] = select.value.split(',').map(Number);
  state.nucleus = { Z, N };
  state.fusionPair = null;
  renderNucleus();
  playSound('click');
};

window.tryDecay = function(type) {
  playSound('click');
  if (type === 'alpha') {
    performAlphaDecay();
  } else if (type === 'beta') {
    performBetaDecay();
  } else if (type === 'gamma') {
    performGammaEmission();
  }
};

window.checkEquation = function() {
  const ansAEl = document.getElementById('ans-A');
  const ansZEl = document.getElementById('ans-Z');
  const ansA = ansAEl ? ansAEl.value.trim() : '';
  const ansZ = ansZEl ? ansZEl.value.trim() : '';
  const feedback = document.getElementById('feedback-l3');

  if (!feedback) return;

  // C-14 beta decay: C(6,8) -> N(7,7) + e
  // A stays 14, Z goes from 6 to 7
  const correctA = '14';
  const correctZ = '7';

  if (ansA === correctA && ansZ === correctZ) {
    feedback.className = 'quiz-feedback show correct';
    feedback.textContent = '‚úì Perfect! A=14 (unchanged), Z=7 (increased by 1 because a neutron became a proton)';
    addXP(30);
    playSound('success');
  } else {
    feedback.className = 'quiz-feedback show incorrect';
    let hint = '‚úó Not quite. ';
    if (ansA !== correctA && ansZ !== correctZ) {
      hint += 'Check both A and Z. In Œ≤‚Åª decay, A stays the same and Z increases by 1.';
    } else if (ansA !== correctA) {
      hint += 'Check A (mass number). Does it change in beta decay?';
    } else {
      hint += 'Check Z (atomic number). A neutron becomes a proton, so Z should...?';
    }
    feedback.textContent = hint;
    updateSafety(-3);
    playSound('error');

    // Allow retry - clear inputs after delay
    setTimeout(() => {
      feedback.classList.remove('show');
    }, 3500);
  }
};

window.showHint3 = function() {
  showToast('Hint: In Œ≤‚Åª decay, a neutron turns into a proton. What happens to Z?', 'info');
  addXP(-5);
};

window.loadIsotopeL4 = function() {
  const select = document.getElementById('isotope-select-l4');
  if (select.value === 'fission') {
    state.nucleus = { Z: 92, N: 143 };
    state.fusionPair = null;
  } else {
    state.fusionPair = [{ Z: 1, N: 1 }, { Z: 1, N: 2 }];
    state.nucleus = { Z: 1, N: 1 };
  }
  renderNucleus();
  playSound('click');
};

window.triggerFission = function() {
  if (state.nucleus.Z === 92) {
    performFission();
    playSound('decay');
  } else {
    showToast('Load U-235 first!', 'error');
  }
};

window.triggerFusion = function() {
  if (state.fusionPair) {
    performFusion();
    playSound('decay');
  } else {
    showToast('Load D + T fusion pair first!', 'error');
  }
};

window.checkApplications = function() {
  const q1El = document.getElementById('app-q1');
  const q2El = document.getElementById('app-q2');
  const q3El = document.getElementById('app-q3');
  const feedback = document.getElementById('feedback-l5-app');

  if (!q1El || !q2El || !q3El || !feedback) return;

  const q1 = q1El.value;
  const q2 = q2El.value;
  const q3 = q3El.value;

  // Check if all questions are answered
  if (!q1 || !q2 || !q3) {
    showToast('Please answer all three questions', 'error');
    return;
  }

  let correct = 0;
  let hints = [];
  if (q1 === 'alpha') correct++;
  else hints.push('Smoke detectors use the most ionizing radiation that can be easily contained.');
  if (q2 === 'gamma') correct++;
  else hints.push('Medical imaging needs radiation that can penetrate the body.');
  if (q3 === 'fission') correct++;
  else hints.push('Current power plants split heavy atoms.');

  if (correct === 3) {
    feedback.className = 'quiz-feedback show correct';
    feedback.textContent = '‚úì All correct! Smoke detectors use alpha (easily shielded), medical imaging uses gamma (penetrates body), and power plants use fission.';
    addXP(30);
    playSound('success');
  } else {
    feedback.className = 'quiz-feedback show incorrect';
    feedback.textContent = `‚úó ${correct}/3 correct. Hint: ${hints[0]} Try again!`;
    updateSafety(-2);
    playSound('error');

    // Allow retry - hide feedback after delay
    setTimeout(() => {
      feedback.classList.remove('show');
    }, 4000);
  }
};

// ============================================
// ACTION BUTTON HANDLERS
// ============================================
document.getElementById('btn-alpha').addEventListener('click', () => {
  if (performAlphaDecay()) {
    showToast('Alpha decay: lost 2 protons + 2 neutrons', 'success');
  }
});

document.getElementById('btn-beta').addEventListener('click', () => {
  if (performBetaDecay()) {
    showToast('Beta decay: neutron ‚Üí proton + electron', 'success');
  }
});

document.getElementById('btn-gamma').addEventListener('click', () => {
  if (performGammaEmission()) {
    showToast('Gamma emission: energy released, no change to A or Z', 'success');
  }
});

document.getElementById('btn-fission').addEventListener('click', () => {
  if (state.nucleus.Z === 92) {
    performFission();
  } else {
    showToast('Load U-235 for fission demo', 'error');
  }
});

document.getElementById('btn-fusion').addEventListener('click', () => {
  if (state.fusionPair) {
    performFusion();
  } else {
    showToast('Load D+T pair for fusion demo', 'error');
  }
});

// ============================================
// LEVEL TAB HANDLERS
// ============================================
document.querySelectorAll('.level-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const level = parseInt(tab.dataset.level);
    loadLevel(level);
  });
});

// ============================================
// SOUND TOGGLE
// ============================================
document.getElementById('sound-toggle').addEventListener('click', () => {
  state.soundEnabled = !state.soundEnabled;
  document.getElementById('sound-toggle').textContent = state.soundEnabled ? 'üîä' : 'üîá';
  playSound('click');
});

// ============================================
// RESIZE HANDLER
// ============================================
window.addEventListener('resize', () => {
  camera.aspect = container.clientWidth / container.clientHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(container.clientWidth, container.clientHeight);
});

// ============================================
// ANIMATION LOOP
// ============================================
let lastTime = performance.now();

function animate(currentTime) {
  requestAnimationFrame(animate);

  const delta = (currentTime - lastTime) / 1000;
  lastTime = currentTime;

  controls.update();

  // Rotate nucleus
  nucleusGroup.rotation.y += 0.2 * delta;

  // Update animations
  updateAnimation(delta);

  renderer.render(scene, camera);
}

// ============================================
// INITIALIZE
// ============================================
function init() {
  const hasProgress = loadProgress();

  // Determine which level to start with
  let startLevel = 1;
  if (hasProgress && state.unlockedLevels.length > 0) {
    const incompleteLevel = state.unlockedLevels.filter(l => !state.completedLevels.includes(l));
    if (incompleteLevel.length > 0) {
      startLevel = Math.min(...incompleteLevel); // Start at lowest incomplete level
    } else {
      // All unlocked levels completed - go to highest completed or last unlocked
      startLevel = Math.max(...state.unlockedLevels);
    }
  }

  loadLevel(startLevel);
  updateProgress();
  updateBadges();
  animate(performance.now());

  if (hasProgress && state.xp > 0) {
    showToast(`Welcome back! Your progress has been restored. XP: ${state.xp}`, 'success');
  } else {
    showToast('Welcome to Nuclear Reactions Lab! Start with Level 1.', 'info');
  }
}

// Reset progress function (can be called from console or added to UI)
window.resetProgress = function() {
  if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
    localStorage.removeItem('nuclearLabProgress');
    location.reload();
  }
};

init();
</script>
</body>
</html>
